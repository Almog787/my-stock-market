name: Manual Portfolio Analysis

on:
  workflow_dispatch:

jobs:
  analyze:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas yfinance matplotlib numpy pytz

      - name: Ensure Analysis Script Exists
        run: |
          cat << 'EOF' > analysis_pro.py
          import json
          import pandas as pd
          import numpy as np
          import matplotlib.pyplot as plt
          import os
          from datetime import datetime

          DATA_DIR = "data_hub"
          HISTORY_FILE = os.path.join(DATA_DIR, "stock_history.json")
          PORTFOLIO_FILE = os.path.join(DATA_DIR, "portfolio.json")
          REPORT_FILE = "ANALYSIS_REPORT.md"
          PREDICTION_CHART = os.path.join(DATA_DIR, "predictions.png")

          def get_reversion_details(df, ticker):
              current_price = df[ticker].iloc[-1]
              avg_price = df[ticker].mean()
              std_dev = df[ticker].std()
              z_score = (current_price - avg_price) / std_dev if std_dev > 0 else 0
              
              if z_score > 1.5:
                  return "ğŸ”´ **××ª×™×—×ª ×™×ª×¨ ×œ××¢×œ×”**: ×”××—×™×¨ ×’×‘×•×” ××©××¢×•×ª×™×ª ××”×××•×¦×¢ ×”×”×™×¡×˜×•×¨×™ ×©×œ×š. ×¡×™×›×•×Ÿ ××•×’×‘×¨ ×œ×ª×™×§×•×Ÿ."
              elif z_score < -1.5:
                  return "ğŸŸ¢ **×”×–×“×× ×•×ª ×¢×¨×š**: ×”××—×™×¨ × ××•×š ××©××¢×•×ª×™×ª ××”×××•×¦×¢. ×™×™×ª×›×Ÿ ×©××“×•×‘×¨ ×‘× ×§×•×“×ª ×›× ×™×¡×” × ×•×—×”."
              return "âšª **××—×™×¨ ×”×•×’×Ÿ**: ×”×× ×™×” × ×¡×—×¨×ª ×¡×‘×™×‘ ×”×××•×¦×¢ ×”×”×™×¡×˜×•×¨×™ ×©×œ×”."

          def get_momentum_details(df, ticker):
              prices = df[ticker].dropna()
              if len(prices) < 20: return "â³ ×¦×‘×™×¨×ª × ×ª×•× ×™×..."
              ma_short = prices.rolling(window=20).mean().iloc[-1]
              ma_long = prices.rolling(window=min(len(prices), 50)).mean().iloc[-1]
              
              if ma_short > ma_long:
                  return "ğŸš€ **××’××” ×¢×•×œ×”**: ×”×××•×¦×¢ ×œ×˜×•×•×— ×§×¦×¨ ××¢×œ ×”××¨×•×š - ×”××•×× ×˜×•× ×—×™×•×‘×™."
              return "âš ï¸ **××’××” ×™×•×¨×“×ª**: ×”××•×× ×˜×•× × ×—×œ×©, ×”××—×™×¨ ××ª×§×©×” ×œ×¤×¨×•×¥ ×œ××¢×œ×”."

          def get_rsi_details(rsi):
              if rsi > 70:
                  return "ğŸ”¥ **×§× ×™×™×ª ×™×ª×¨**: ×”×× ×™×” '×—××”' ××“×™. ×™×™×ª×›×Ÿ ×©×™×™×“×¨×© ××•×•×¨×•×¨ ×‘×§×¨×•×‘."
              elif rsi < 30:
                  return "ğŸ§Š **××›×™×¨×ª ×™×ª×¨**: ×¤×× ×™×§×” ×©×œ ××•×›×¨×™×. ×œ×¢×™×ª×™× ×§×¨×•×‘×•×ª ××§×“×™× ×–×™× ×•×§ ×œ××¢×œ×”."
              return "âš–ï¸ **× ×™×˜×¨×œ×™**: ×¢×•×¦××ª ×”×§×•× ×™× ×•×”××•×›×¨×™× ×××•×–× ×ª."

          def main():
              if not os.path.exists(HISTORY_FILE) or not os.path.exists(PORTFOLIO_FILE):
                  return
              with open(PORTFOLIO_FILE, 'r') as f: holdings = json.load(f)
              with open(HISTORY_FILE, 'r') as f: history = json.load(f)
              
              df = pd.DataFrame([{"ts": e['timestamp'], **e['prices']} for e in history])
              df['ts'] = pd.to_datetime(df['ts'])
              df = df.sort_values('ts')
              
              tickers = list(holdings.keys())
              sections = []
              
              plt.figure(figsize=(12, 6))
              plt.style.use('dark_background')

              for t in tickers:
                  if t not in df.columns: continue
                  
                  rev = get_reversion_details(df, t)
                  mom = get_momentum_details(df, t)
                  
                  # RSI ×—×™×©×•×‘
                  delta = df[t].diff()
                  gain = delta.where(delta > 0, 0).rolling(14).mean()
                  loss = -delta.where(delta < 0, 0).rolling(14).mean()
                  rs = gain / loss
                  rsi_val = 100 - (100 / (1 + rs.iloc[-1])) if not pd.isna(rs.iloc[-1]) else 50
                  rsi_desc = get_rsi_details(rsi_val)
                  
                  sections.append(f"### ğŸ“ˆ {t}\n"
                                  f"- **××¦×‘ ××—×™×¨:** {rev}\n"
                                  f"- **××’××ª ××•×× ×˜×•×:** {mom}\n"
                                  f"- **××“×“ ×¢×•×¦××” (RSI):** {rsi_val:.1f} - {rsi_desc}\n")
                  
                  plt.plot(df['ts'], (df[t]/df[t].iloc[0])*100, label=t, alpha=0.8, linewidth=2)

              plt.title("Portfolio Performance Comparison (Normalized)")
              plt.legend(); plt.savefig(PREDICTION_CHART, bbox_inches='tight'); plt.close()
              
              report = [
                  "# ğŸ§  ×“×•×— × ×™×ª×•×— ××¤×•×¨×˜ ×•×ª×—×–×™×•×ª",
                  f"×¢×“×›×•×Ÿ: {datetime.now().strftime('%d/%m/%Y %H:%M')}\n",
                  "## ğŸ” × ×™×ª×•×— ××¢××™×§ ×œ×¤×™ ×× ×™×”",
                  "\n".join(sections),
                  "## ğŸ“Š ×”×©×•×•××ª ×¦××™×—×” ×™×—×¡×™×ª",
                  f"![Predictions](./{PREDICTION_CHART})",
                  "\n---",
                  "### ğŸ“” ××™×œ×•×Ÿ ××•× ×—×™× ×œ××©×§×™×¢:",
                  "- **Mean Reversion (×—×–×¨×” ×œ×××•×¦×¢):** ×”× ×—×” ×©××—×™×¨ ×”×× ×™×” ×ª××™×“ ×™×—×–×•×¨ ×œ×××•×¦×¢ ×©×œ×•. ×¡×˜×™×™×” ×—×¨×™×’×” ×”×™× ×”×–×“×× ×•×ª ××• × ×•×¨×ª ××–×”×¨×”.",
                  "- **RSI (××“×“ ×¢×•×¦××” ×™×—×¡×™×ª):** ×›×œ×™ ×©××•×“×“ ××ª ××”×™×¨×•×ª ×©×™× ×•×™×™ ×”××—×™×¨. ×¢×•×–×¨ ×œ×–×”×•×ª ××ª×™ ×”×¦×™×‘×•×¨ ×¨×¥ ×œ×§× ×•×ª/×œ××›×•×¨ ×‘×˜×™×¨×•×£.",
                  "- **Momentum (××•×× ×˜×•×):** ×‘×•×“×§ ×× '×”×¨×•×— ×‘×’×‘' ×©×œ ×”×× ×™×”. ×× ×™×” ×‘××•×× ×˜×•× ×—×™×•×‘×™ × ×•×˜×” ×œ×”××©×™×š ×œ×¢×œ×•×ª."
              ]
              
              with open(REPORT_FILE, 'w', encoding='utf-8') as f:
                  f.write("\n".join(report))

          if __name__ == "__main__": main()
          EOF

      - name: Run Analysis Script
        run: python analysis_pro.py

      - name: Commit and Push Changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add ANALYSIS_REPORT.md data_hub/predictions.png analysis_pro.py
          git commit -m "Comprehensive analysis update with interpretations" || echo "No changes"
          git push
