<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>מערכת ניתוח תיק השקעות אישית</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --accent: #3b82f6; }
        body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .card { background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid #334155; }
        .val { font-size: 1.8rem; font-weight: bold; margin-top: 10px; }
        .label { color: #94a3b8; font-size: 0.9rem; }
        .chart-container { background: var(--card); padding: 20px; border-radius: 12px; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; background: var(--card); border-radius: 12px; overflow: hidden; }
        th, td { padding: 12px; text-align: right; border-bottom: 1px solid #334155; }
        th { background: #334155; }
        .pos { color: #10b981; } .neg { color: #f43f5e; }
    </style>
</head>
<body>

    <h2 id="mainTitle">טוען נתונים מה-Data Hub...</h2>

    <div class="grid">
        <div class="card">
            <div class="label">שווי תיק נוכחי (USD)</div>
            <div id="totalVal" class="val">$0</div>
        </div>
        <div class="card">
            <div class="label">תשואה מצטברת</div>
            <div id="totalRet" class="val">0%</div>
        </div>
        <div class="card">
            <div class="label">Max Drawdown</div>
            <div id="maxDD" class="val neg">0%</div>
        </div>
        <div class="card">
            <div class="label">המניה המנצחת</div>
            <div id="bestStock" class="val pos">-</div>
        </div>
    </div>

    <div class="chart-container">
        <canvas id="mainChart" height="100"></canvas>
    </div>

    <table>
        <thead>
            <tr>
                <th>נכס</th>
                <th>כמות</th>
                <th>מחיר</th>
                <th>שווי פוזיציה</th>
                <th>משקל</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>

<script>
    async function fetchData() {
        try {
            // משיכת הנתונים מהקבצים שלך בלבד
            const [history, portfolio] = await Promise.all([
                fetch('data_hub/stock_history.json').then(r => r.json()),
                fetch('data_hub/portfolio.json').then(r => r.json())
            ]);

            const tickers = Object.keys(portfolio);
            const last = history[history.length - 1];
            const first = history[0];

            // פונקציית עזר לחישוב שווי תיק בנקודת זמן
            const calcValue = (data) => tickers.reduce((sum, t) => sum + (data.prices[t] * portfolio[t] || 0), 0);

            // 1. שווי ותשואה
            const currentVal = calcValue(last);
            const initialVal = calcValue(first);
            const totalReturn = ((currentVal / initialVal) - 1) * 100;

            document.getElementById('mainTitle').innerText = `ניתוח תיק - ${last.timestamp}`;
            document.getElementById('totalVal').innerText = `$${currentVal.toLocaleString()}`;
            document.getElementById('totalRet').innerText = `${totalReturn.toFixed(2)}%`;
            document.getElementById('totalRet').classList.add(totalReturn >= 0 ? 'pos' : 'neg');

            // 2. חישוב Max Drawdown (זהה לניתוח ב-README)
            let peak = 0;
            let mdd = 0;
            history.forEach(h => {
                const v = calcValue(h);
                if (v > peak) peak = v;
                const dd = (v / peak) - 1;
                if (dd < mdd) mdd = dd;
            });
            document.getElementById('maxDD').innerText = `${(mdd * 100).toFixed(2)}%`;

            // 3. מציאת המניה הטובה ביותר
            let bestStock = '';
            let bestPerf = -Infinity;
            tickers.forEach(t => {
                const p = ((last.prices[t] / first.prices[t]) - 1) * 100;
                if (p > bestPerf) { bestPerf = p; bestStock = t; }
            });
            document.getElementById('bestStock').innerText = `${bestStock} (+${bestPerf.toFixed(1)}%)`;

            // 4. בניית הטבלה
            document.getElementById('tableBody').innerHTML = tickers.map(t => `
                <tr>
                    <td><b>${t}</b></td>
                    <td>${portfolio[t]}</td>
                    <td>$${last.prices[t]}</td>
                    <td>$${(last.prices[t] * portfolio[t]).toLocaleString()}</td>
                    <td>${((last.prices[t] * portfolio[t] / currentVal) * 100).toFixed(1)}%</td>
                </tr>
            `).join('');

            // 5. גרף ביצועים מנורמל (100)
            new Chart(document.getElementById('mainChart'), {
                type: 'line',
                data: {
                    labels: history.map(h => h.timestamp.split(' ')[0]),
                    datasets: [{
                        label: 'ביצועי התיק (%)',
                        data: history.map(h => (calcValue(h) / initialVal * 100).toFixed(2)),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } } }
                }
            });

        } catch (err) {
            document.getElementById('mainTitle').innerText = "שגיאה בטעינת הנתונים מה-Data Hub";
        }
    }
    fetchData();
</script>
</body>
</html>
